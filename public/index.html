<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Dream Weaver - –ò–≥—Ä–∞ –≤ –º–∏—Ä–µ —Å–Ω–æ–≤</title>
    
    <!-- Meta —Ç–µ–≥–∏ –¥–ª—è Telegram Web App -->
    <meta property="og:title" content="AI Dream Weaver">
    <meta property="og:description" content="–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –∏–≥—Ä–∞ —Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π –º–∏—Ä–æ–≤ –Ω–µ–π—Ä–æ—Å–µ—Ç—è–º–∏">
    <meta property="og:image" content="https://images.unsplash.com/photo-1518709268805-4e9042af2176?auto=format&fit=crop&w=512&q=80">
    <meta property="og:url" content="https://ai-dream-weaver.vercel.app">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üåå</text></svg>">
    
    <!-- Phaser 3 -->
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
    
    <!-- Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <style>
        /* ========== –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ ========== */
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            margin: 0;
            padding: 0;
        }

        body {
            margin: 0;
            padding: 0;
            background: #0a0a1a;
            color: #fff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            touch-action: manipulation;
            height: 100vh;
            width: 100vw;
            user-select: none;
        }

        /* ========== –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏–≥—Ä—ã ========== */
        #game-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            background: linear-gradient(135deg, #0a0a1a 0%, #1a1a2e 50%, #16213e 100%);
        }

        #game-container canvas {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 10px;
            box-shadow: 0 0 50px rgba(74, 111, 255, 0.1);
        }

        /* ========== –û—Å–Ω–æ–≤–Ω–æ–π UI –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä ========== */
        .ui-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            pointer-events: none;
            z-index: 100;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
            gap: 10px;
        }

        /* ========== –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏—Å—Ç–æ—Ä–∏–∏ ========== */
        .story-container {
            flex: 1;
            max-height: 40vh;
            min-height: 30vh;
            background: rgba(0, 0, 30, 0.92);
            backdrop-filter: blur(20px) saturate(180%);
            border: 2px solid #4a6fff;
            border-radius: 20px;
            padding: 20px;
            margin: 15px;
            margin-bottom: 0;
            overflow-y: auto;
            pointer-events: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            transition: all 0.3s ease;
        }

        .story-container:hover {
            border-color: #6a8fff;
            box-shadow: 0 15px 40px rgba(74, 111, 255, 0.2);
        }

        .story-text {
            font-size: 16px;
            line-height: 1.6;
            margin: 0;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.8);
        }

        .story-text strong {
            color: #8a2fff;
        }

        .story-text i {
            color: #88ff88;
            font-style: italic;
        }

        /* ========== –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤–≤–æ–¥–∞ ========== */
        .input-container {
            background: rgba(0, 0, 20, 0.95);
            backdrop-filter: blur(25px) saturate(200%);
            border: 2px solid #8a2fff;
            border-radius: 20px;
            padding: 15px;
            margin: 15px;
            margin-top: 0;
            display: flex;
            gap: 12px;
            pointer-events: auto;
            box-shadow: 0 -5px 25px rgba(0, 0, 0, 0.5);
        }

        #user-input {
            flex: 1;
            padding: 18px 20px;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.08);
            color: #fff;
            border: 2px solid #4a6fff;
            border-radius: 15px;
            outline: none;
            min-height: 56px;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        #user-input:focus {
            background: rgba(255, 255, 255, 0.12);
            border-color: #6a8fff;
            box-shadow: 0 0 20px rgba(74, 111, 255, 0.3);
        }

        #user-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        #action-btn {
            padding: 0 30px;
            background: linear-gradient(135deg, #4a6fff, #8a2fff);
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            min-width: 90px;
            transition: all 0.3s ease;
            font-family: inherit;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #action-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(138, 47, 255, 0.4);
        }

        #action-btn:active:not(:disabled) {
            transform: translateY(0);
        }

        #action-btn:disabled {
            background: #555;
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* ========== –ë–æ–∫–æ–≤—ã–µ –ø–∞–Ω–µ–ª–∏ ========== */
        .side-panel {
            position: fixed;
            top: 50%;
            transform: translateY(-50%);
            width: 320px;
            max-width: 85vw;
            background: rgba(0, 0, 30, 0.98);
            backdrop-filter: blur(25px) saturate(200%);
            border: 2px solid #4a6fff;
            border-radius: 20px;
            padding: 20px;
            overflow-y: auto;
            pointer-events: auto;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.6);
            display: none;
            z-index: 150;
        }

        #inventory-panel {
            left: 15px;
            max-height: 80vh;
        }

        #quest-panel {
            right: 15px;
            max-height: 80vh;
        }

        .side-panel h3 {
            color: #8a2fff;
            margin-bottom: 20px;
            font-size: 22px;
            text-align: center;
            border-bottom: 2px solid #4a6fff;
            padding-bottom: 10px;
        }

        .side-panel ul {
            list-style: none;
            padding: 0;
        }

        .side-panel li {
            padding: 12px 15px;
            margin: 8px 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            border-left: 4px solid #4a6fff;
            transition: all 0.3s ease;
        }

        .side-panel li:hover {
            background: rgba(74, 111, 255, 0.1);
            transform: translateX(5px);
        }

        /* ========== –ö–Ω–æ–ø–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –ø–∞–Ω–µ–ª–µ–π ========== */
        .toggle-panel-btn {
            position: fixed;
            top: 50%;
            transform: translateY(-50%);
            width: 50px;
            height: 120px;
            background: linear-gradient(135deg, rgba(74, 111, 255, 0.9), rgba(138, 47, 255, 0.9));
            border: none;
            border-radius: 0 15px 15px 0;
            color: white;
            font-size: 28px;
            cursor: pointer;
            z-index: 101;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            pointer-events: auto;
        }

        .toggle-panel-btn:hover {
            width: 60px;
            box-shadow: 0 10px 25px rgba(74, 111, 255, 0.4);
        }

        #toggle-inventory {
            left: 0;
            border-radius: 0 15px 15px 0;
        }

        #toggle-quests {
            right: 0;
            border-radius: 15px 0 0 15px;
        }

        /* ========== UI –±–æ—è ========== */
        #battle-ui {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 95%;
            max-width: 600px;
            background: rgba(30, 0, 0, 0.98);
            backdrop-filter: blur(25px) saturate(200%);
            padding: 25px;
            border-radius: 25px;
            text-align: center;
            display: none;
            pointer-events: auto;
            z-index: 200;
            border: 3px solid #ff4444;
            box-shadow: 0 15px 40px rgba(255, 0, 0, 0.3);
        }

        .battle-btn {
            margin: 10px;
            padding: 18px 24px;
            font-size: 17px;
            background: linear-gradient(135deg, #ff6600, #ff3300);
            color: #fff;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            flex: 1;
            min-width: 120px;
            font-weight: bold;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .battle-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(255, 102, 0, 0.4);
        }

        .battle-btn:active {
            transform: translateY(0);
        }

        /* ========== HP –±–∞—Ä—ã ========== */
        .hp-bar {
            height: 30px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 15px;
            overflow: hidden;
            position: relative;
            margin: 15px 0;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .hp-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ff88, #00cc66);
            border-radius: 15px;
            width: 100%;
            transition: width 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
        }

        .hp-fill.danger {
            background: linear-gradient(90deg, #ff5555, #cc0000);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .hp-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .hp-text {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.8);
            color: white;
            font-size: 14px;
        }

        /* ========== –ö–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞ ========== */
        .choice-btn {
            display: block;
            margin: 12px auto;
            padding: 18px;
            background: linear-gradient(135deg, #3366ff, #2244cc);
            color: #fff;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            width: 95%;
            max-width: 450px;
            font-size: 16px;
            font-weight: bold;
            pointer-events: auto;
            box-shadow: 0 8px 20px rgba(51, 102, 255, 0.3);
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .choice-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 25px rgba(51, 102, 255, 0.4);
            background: linear-gradient(135deg, #4477ff, #3355dd);
        }

        .choice-btn:active {
            transform: translateY(0);
        }

        /* ========== –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è ========== */
        #notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, rgba(0, 0, 30, 0.95), rgba(26, 26, 46, 0.95));
            backdrop-filter: blur(20px);
            border: 2px solid #4a6fff;
            border-radius: 15px;
            padding: 18px 25px;
            color: white;
            font-weight: bold;
            z-index: 1000;
            display: none;
            pointer-events: none;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
            text-align: center;
            max-width: 90%;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        /* ========== –ó–∞–≥—Ä—É–∑—á–∏–∫ ========== */
        #loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 10, 26, 0.95);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            transition: opacity 0.5s ease;
        }

        .loader-spinner {
            width: 80px;
            height: 80px;
            border: 6px solid rgba(74, 111, 255, 0.2);
            border-top: 6px solid #4a6fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loader-text {
            color: #8a2fff;
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            margin-top: 20px;
        }

        /* ========== –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å ========== */
        @media (max-height: 700px) {
            .story-container {
                max-height: 35vh;
                padding: 15px;
            }
            
            .story-text {
                font-size: 15px;
            }
            
            .input-container {
                padding: 12px;
            }
            
            #user-input {
                padding: 15px 18px;
                font-size: 15px;
                min-height: 50px;
            }
            
            #action-btn {
                padding: 0 25px;
                font-size: 16px;
                min-width: 80px;
            }
            
            .side-panel {
                width: 280px;
                padding: 15px;
            }
        }

        @media (max-height: 600px) {
            .story-container {
                max-height: 30vh;
            }
            
            .story-text {
                font-size: 14px;
            }
        }

        @media (max-width: 768px) {
            .side-panel {
                width: 90vw;
            }
            
            .battle-btn {
                min-width: 100px;
                padding: 15px 20px;
                font-size: 15px;
            }
        }

        /* ========== –ö–∞—Å—Ç–æ–º–Ω—ã–π —Å–∫—Ä–æ–ª–ª–±–∞—Ä ========== */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #4a6fff, #8a2fff);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #6a8fff, #aa4fff);
        }

        /* ========== –ê–Ω–∏–º–∞—Ü–∏–∏ ========== */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .floating {
            animation: float 3s ease-in-out infinite;
        }
    </style>
</head>
<body>
    <!-- –ó–∞–≥—Ä—É–∑—á–∏–∫ -->
    <div id="loader">
        <div class="loader-spinner"></div>
        <div class="loader-text">üåå –ü—Ä–æ–±—É–∂–¥–µ–Ω–∏–µ –º–∏—Ä–∞ —Å–Ω–æ–≤...</div>
        <div style="margin-top: 30px; color: rgba(255,255,255,0.6); font-size: 14px; max-width: 300px; text-align: center;">
            –ü–µ—Ä–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥
        </div>
    </div>

    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è Phaser -->
    <div id="game-container"></div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π UI -->
    <div class="ui-container">
        <div class="story-container">
            <div id="story-text" class="story-text">
                <strong style="color: #8a2fff; font-size: 18px;">üåå AI DREAM WEAVER</strong><br><br>
                –í—ã –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç–µ –≥–ª–∞–∑–∞ –≤ –Ω–µ–∑–Ω–∞–∫–æ–º–æ–º –º–µ—Å—Ç–µ. –í–æ–∑–¥—É—Ö –Ω–∞–ø–æ–ª–Ω–µ–Ω –º–∞–≥–∏–µ–π, –∞ –≤–æ–∫—Ä—É–≥ ‚Äî –º–∏—Ä, —Å–æ–∑–¥–∞–Ω–Ω—ã–π –∏–∑ —Å–Ω–æ–≤.<br><br>
                –í—ã —á—É–≤—Å—Ç–≤—É–µ—Ç–µ, —á—Ç–æ –º–æ–∂–µ—Ç–µ –≤–ª–∏—è—Ç—å –Ω–∞ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å —Å–∏–ª–æ–π –º—ã—Å–ª–∏... –ß—Ç–æ –≤—ã —Å–¥–µ–ª–∞–µ—Ç–µ –≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å?
            </div>
        </div>
        
        <div class="input-container">
            <input type="text" id="user-input" placeholder="–û–ø–∏—à–∏—Ç–µ –≤–∞—à–µ –¥–µ–π—Å—Ç–≤–∏–µ... (–Ω–∞–ø—Ä–∏–º–µ—Ä: '–æ—Å–º–æ—Ç—Ä—é—Å—å –≤–æ–∫—Ä—É–≥')" autocomplete="off" autofocus>
            <button id="action-btn">‚ñ∂Ô∏è</button>
        </div>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∏ –±–æ–∫–æ–≤—ã—Ö –ø–∞–Ω–µ–ª–µ–π -->
    <button class="toggle-panel-btn" id="toggle-inventory">üéí</button>
    <button class="toggle-panel-btn" id="toggle-quests">üìú</button>

    <!-- –ü–∞–Ω–µ–ª—å –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è -->
    <div id="inventory-panel" class="side-panel">
        <h3>üéí –ò–ù–í–ï–ù–¢–ê–†–¨</h3>
        <ul id="inventory-list">
            <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è -->
        </ul>
        
        <div style="margin: 20px 0;">
            <div style="display: flex; justify-content: space-between; font-size: 14px; margin-bottom: 8px;">
                <span>‚ù§Ô∏è –ó–î–û–†–û–í–¨–ï</span>
                <span id="hp-value">100/100</span>
            </div>
            <div class="hp-bar">
                <div id="player-hp-fill" class="hp-fill" style="width: 100%">
                    <div class="hp-text">100%</div>
                </div>
            </div>
        </div>
        
        <div id="player-stats" style="text-align: center; margin-top: 20px; font-size: 15px; color: #8a2fff; background: rgba(138, 47, 255, 0.1); padding: 12px; border-radius: 10px;">
            <div>‚öîÔ∏è –£—Ä–æ–≤–µ–Ω—å: <span id="player-level">1</span></div>
            <div>üó°Ô∏è –ê—Ç–∞–∫–∞: <span id="player-attack">10</span></div>
            <div>üõ°Ô∏è –ó–∞—â–∏—Ç–∞: <span id="player-defense">5</span></div>
            <div>‚≠ê –û–ø—ã—Ç: <span id="player-exp">0</span>/100</div>
        </div>
        
        <div style="margin-top: 20px; padding: 15px; background: rgba(74, 111, 255, 0.1); border-radius: 10px; font-size: 13px; color: rgba(255,255,255,0.7);">
            üí° <strong>–°–æ–≤–µ—Ç:</strong> –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–µ–¥–º–µ—Ç—ã –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ –≤–æ –≤—Ä–µ–º—è –±–æ—è!
        </div>
    </div>

    <!-- –ü–∞–Ω–µ–ª—å –∫–≤–µ—Å—Ç–æ–≤ -->
    <div id="quest-panel" class="side-panel">
        <h3>üìú –ö–í–ï–°–¢–´</h3>
        <div id="quest-log">
            <div style="margin-bottom: 20px; padding: 15px; background: rgba(255, 215, 0, 0.1); border-radius: 10px; border-left: 4px solid #FFD700;">
                <strong style="color: #FFD700;">üåü –ì–õ–ê–í–ù–´–ô –ö–í–ï–°–¢:</strong><br>
                <span id="main-quest-title">–ü—Ä–æ–±—É–¥–∏—Ç—å –•—Ä–∞–Ω–∏—Ç–µ–ª—è –°–Ω–æ–≤</span>
            </div>
            
            <div style="font-size: 15px; margin-bottom: 25px;">
                <div style="margin-left: 10px; margin-bottom: 8px; display: flex; align-items: center; gap: 10px;">
                    <span id="quest-1-status">‚è≥</span>
                    <span id="quest-1-text">–ù–∞–π—Ç–∏ –ö—Ä–∞—Å–Ω—ã–π –ö—Ä–∏—Å—Ç–∞–ª–ª</span>
                </div>
                <div style="margin-left: 10px; margin-bottom: 8px; display: flex; align-items: center; gap: 10px;">
                    <span id="quest-2-status">‚è≥</span>
                    <span id="quest-2-text">–ù–∞–π—Ç–∏ –°–∏–Ω–∏–π –ö—Ä–∏—Å—Ç–∞–ª–ª</span>
                </div>
                <div style="margin-left: 10px; margin-bottom: 8px; display: flex; align-items: center; gap: 10px;">
                    <span id="quest-3-status">‚è≥</span>
                    <span id="quest-3-text">–ù–∞–π—Ç–∏ –ó–µ–ª—ë–Ω—ã–π –ö—Ä–∏—Å—Ç–∞–ª–ª</span>
                </div>
                <div style="margin-left: 10px; margin-bottom: 8px; display: flex; align-items: center; gap: 10px;">
                    <span id="quest-4-status">‚è≥</span>
                    <span id="quest-4-text">–ü—Ä–æ–≤–µ—Å—Ç–∏ —Ä–∏—Ç—É–∞–ª –ø—Ä–æ–±—É–∂–¥–µ–Ω–∏—è</span>
                </div>
            </div>
            
            <div id="side-quests-container" style="display: none;">
                <strong style="color: #8a2fff; display: block; margin-bottom: 15px;">üåà –ü–æ–±–æ—á–Ω—ã–µ –∫–≤–µ—Å—Ç—ã:</strong>
                <div id="side-quests-list"></div>
            </div>
            
            <div style="margin-top: 20px; padding: 12px; background: rgba(0, 255, 136, 0.1); border-radius: 10px; font-size: 13px; color: rgba(255,255,255,0.7);">
                üíé <strong>–ü—Ä–æ–≥—Ä–µ—Å—Å:</strong> <span id="quest-progress">0%</span>
            </div>
        </div>
    </div>

    <!-- UI –±–æ—è -->
    <div id="battle-ui">
        <h2 id="enemy-title" style="margin: 0 0 25px 0; color: #FFEB3B; font-size: 28px; text-shadow: 0 0 10px rgba(255, 235, 59, 0.5);">‚öîÔ∏è –ù–ê–ß–ê–õ–°–Ø –ë–û–ô!</h2>
        
        <div style="margin: 20px 0;">
            <div style="display: flex; justify-content: space-between; font-size: 15px; margin-bottom: 8px;">
                <span id="enemy-name" style="color: #ff8888;">–¢—ë–º–Ω—ã–π –ü—Ä–∏–∑—Ä–∞–∫</span>
                <span id="enemy-hp-value">100/100</span>
            </div>
            <div class="hp-bar">
                <div id="enemy-hp-fill" class="hp-fill" style="width: 100%">
                    <div class="hp-text">100%</div>
                </div>
            </div>
        </div>
        
        <div style="margin: 20px 0;">
            <div style="display: flex; justify-content: space-between; font-size: 15px; margin-bottom: 8px;">
                <span style="color: #88ff88;">–¢–í–û–Å –ó–î–û–†–û–í–¨–ï</span>
                <span id="player-battle-hp">100/100</span>
            </div>
            <div class="hp-bar">
                <div id="player-battle-hp-fill" class="hp-fill" style="width: 100%">
                    <div class="hp-text">100%</div>
                </div>
            </div>
        </div>
        
        <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 12px; margin-top: 20px;">
            <button class="battle-btn" id="btn-attack">üó°Ô∏è –ê–¢–ê–ö–ê</button>
            <button class="battle-btn" id="btn-item">üß™ –ó–ï–õ–¨–ï</button>
            <button class="battle-btn" id="btn-flee">üèÉ –ü–û–ë–ï–ì</button>
            <button class="battle-btn" id="btn-special" style="background: linear-gradient(135deg, #ff00ff, #8800ff);">‚ú® –°–ü–û–°–û–ë–ù–û–°–¢–¨</button>
        </div>
        
        <div id="battle-log" style="margin-top: 20px; padding: 15px; background: rgba(255, 255, 255, 0.05); border-radius: 10px; font-size: 14px; color: rgba(255,255,255,0.8); text-align: left; max-height: 100px; overflow-y: auto;">
            –ë–æ–π –Ω–∞—á–∞–ª—Å—è! –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ...
        </div>
    </div>

    <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ -->
    <div id="notification"></div>

    <!-- ========== JavaScript ========== -->
    <script>
        // ========== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ==========
        // –î–ª—è Vercel - –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ –ø—É—Ç–∏
        const API_BASE = window.location.origin;
        const SD_API = API_BASE + '/api/sd-proxy';
        const LLM_API = API_BASE + '/api/llm-proxy';
        const HEALTH_API = API_BASE + '/api/health';
        
        console.log('–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è API:', { SD_API, LLM_API });

        // ========== –ü–ï–†–ï–ú–ï–ù–ù–´–ï –ò–ì–†–´ ==========
        let game = null;
        let sceneImage = null;
        let currentImageKey = 'generated';
        let isGenerating = false;
        let battleAnimationActive = false;

        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
        const gameState = {
            history: [],
            inventory: [
                '–ó–µ–ª—å–µ –∑–¥–æ—Ä–æ–≤—å—è (+30 HP)',
                '–ú–∞–≥–∏—á–µ—Å–∫–∏–π —Å–≤–∏—Ç–æ–∫',
                '–ö–ª—é—á –æ—Ç —Å—Ç–∞—Ä–æ–≥–æ —Ö—Ä–∞–º–∞',
                '–ö–∞—Ä—Ç–∞ —Å–Ω–æ–≤'
            ],
            player: {
                hp: 100,
                maxHp: 100,
                attack: 10,
                defense: 5,
                level: 1,
                exp: 0,
                gold: 50,
                mana: 50,
                maxMana: 50
            },
            currentBattle: null,
            quests: {
                main: {
                    title: "–ü—Ä–æ–±—É–¥–∏—Ç—å –•—Ä–∞–Ω–∏—Ç–µ–ª—è –°–Ω–æ–≤",
                    objectives: [
                        { id: 1, text: "–ù–∞–π—Ç–∏ –ö—Ä–∞—Å–Ω—ã–π –ö—Ä–∏—Å—Ç–∞–ª–ª –≤ –û–≥–Ω–µ–Ω–Ω—ã—Ö –ü–µ—â–µ—Ä–∞—Ö", done: false, keyword: "–∫—Ä–∞—Å–Ω—ã–π –∫—Ä–∏—Å—Ç–∞–ª–ª" },
                        { id: 2, text: "–ù–∞–π—Ç–∏ –°–∏–Ω–∏–π –ö—Ä–∏—Å—Ç–∞–ª–ª –≤ –ó–∞—Ç–æ–ø–ª–µ–Ω–Ω–æ–º –•—Ä–∞–º–µ", done: false, keyword: "—Å–∏–Ω–∏–π –∫—Ä–∏—Å—Ç–∞–ª–ª" },
                        { id: 3, text: "–ù–∞–π—Ç–∏ –ó–µ–ª—ë–Ω—ã–π –ö—Ä–∏—Å—Ç–∞–ª–ª –≤ –õ–µ—Å—É –î—É—Ö–æ–≤", done: false, keyword: "–∑–µ–ª–µ–Ω—ã–π –∫—Ä–∏—Å—Ç–∞–ª–ª" },
                        { id: 4, text: "–ü—Ä–æ–≤–µ—Å—Ç–∏ —Ä–∏—Ç—É–∞–ª –ø—Ä–æ–±—É–∂–¥–µ–Ω–∏—è –≤ –ó–∞–ø—Ä–µ—Ç–Ω–æ–π –ë–∞—à–Ω–µ", done: false, keyword: "—Ä–∏—Ç—É–∞–ª" }
                    ],
                    completed: false
                },
                side: [
                    { id: 101, title: "–ü–æ–º–æ—á—å –ø–æ—Ç–µ—Ä—è–Ω–Ω–æ–º—É –¥—É—Ö—É", completed: false },
                    { id: 102, title: "–°–æ–±—Ä–∞—Ç—å 5 –º–∞–≥–∏—á–µ—Å–∫–∏—Ö –≥—Ä–∏–±–æ–≤", completed: false }
                ]
            },
            discoveredLocations: ['–õ–µ—Å –°–Ω–æ–≤'],
            achievements: []
        };

        // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('AI Dream Weaver –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è...');
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º –¥–ª—è –≤–µ—Ä—Å–∏–∏ 6.0
            if (window.Telegram && window.Telegram.WebApp) {
                try {
                    Telegram.WebApp.ready();
                    Telegram.WebApp.expand();
                    
                    // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –º–µ—Ç–æ–¥–∞ –ø–µ—Ä–µ–¥ –≤—ã–∑–æ–≤–æ–º
                    if (typeof Telegram.WebApp.enableClosingConfirmation === 'function') {
                        Telegram.WebApp.enableClosingConfirmation();
                    } else {
                        console.log('enableClosingConfirmation –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ —ç—Ç–æ–π –≤–µ—Ä—Å–∏–∏ Telegram Web App');
                    }
                    
                    console.log('Telegram Web App –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                    console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:', Telegram.WebApp.initDataUnsafe?.user);
                    console.log('–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞:', Telegram.WebApp.platform);
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –≤ –∏—Å—Ç–æ—Ä–∏—é
                    const user = Telegram.WebApp.initDataUnsafe?.user;
                    if (user) {
                        gameState.player.name = user.first_name || '–ü—É—Ç–µ—à–µ—Å—Ç–≤–µ–Ω–Ω–∏–∫';
                        addStoryText(`<span style="color:#8a2fff">‚ú® –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${gameState.player.name}!</span>`);
                    }
                } catch (error) {
                    console.log('Telegram Web App –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω:', error);
                }
            }

            // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
            loadGame();

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Phaser
            initializePhaser();

            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
            setupEventListeners();

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
            updateUI();

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ API
            await checkAPIConnection();

            // –°–∫—Ä—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑—á–∏–∫
            setTimeout(() => {
                document.getElementById('loader').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('loader').style.display = 'none';
                    showNotification('üåå –ú–∏—Ä —Å–Ω–æ–≤ –≥–æ—Ç–æ–≤! –ù–∞—á–Ω–∏—Ç–µ —Å–≤–æ–µ –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏–µ...');
                }, 500);
            }, 1500);
        });

        // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø PHASER ==========
        function initializePhaser() {
            const config = {
                type: Phaser.AUTO,
                parent: 'game-container',
                width: window.innerWidth,
                height: window.innerHeight,
                scene: {
                    preload: preload,
                    create: create,
                    update: update
                },
                scale: {
                    mode: Phaser.Scale.RESIZE,
                    autoCenter: Phaser.Scale.CENTER_BOTH,
                    width: '100%',
                    height: '100%'
                },
                transparent: true,
                backgroundColor: '#0a0a1a',
                fps: {
                    target: 60,
                    forceSetTimeOut: true
                },
                // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –û—Ç–∫–ª—é—á–∞–µ–º –∞—É–¥–∏–æ, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π
                audio: {
                    noAudio: true
                },
                // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
                render: {
                    pixelArt: false,
                    antialias: true,
                    roundPixels: false
                }
            };

            game = new Phaser.Game(config);
        }

        // ========== –§–£–ù–ö–¶–ò–ò PHASER (–ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ï) ==========
        function preload() {
            console.log('Phaser: Preload');
            
            // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –í–º–µ—Å—Ç–æ data URI —Å–æ–∑–¥–∞–µ–º placeholder —Å –ø–æ–º–æ—â—å—é Canvas –≤ create
            // –ù–µ –∑–∞–≥—Ä—É–∂–∞–µ–º –Ω–∏—á–µ–≥–æ –∑–¥–µ—Å—å, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –æ—à–∏–±–∫–∏ "Local data URIs are not supported"
        }

        function create() {
            console.log('Phaser: Create');
            
            const scene = this;
            
            // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –°–æ–∑–¥–∞–µ–º placeholder –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å –ø–æ–º–æ—â—å—é Canvas
            const createPlaceholderImage = () => {
                const canvas = document.createElement('canvas');
                canvas.width = 512;
                canvas.height = 384;
                const ctx = canvas.getContext('2d');
                
                if (!ctx) {
                    console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç canvas');
                    return null;
                }
                
                // –ì—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–π —Ñ–æ–Ω
                const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
                gradient.addColorStop(0, '#0a0a1a');
                gradient.addColorStop(0.5, '#1a1a2e');
                gradient.addColorStop(1, '#16213e');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // –ö—Ä—É–≥–∏
                ctx.strokeStyle = '#4a6fff';
                ctx.lineWidth = 4;
                ctx.beginPath();
                ctx.arc(canvas.width / 2, canvas.height / 2, 80, 0, Math.PI * 2);
                ctx.stroke();
                
                ctx.strokeStyle = '#8a2fff';
                ctx.lineWidth = 4;
                ctx.beginPath();
                ctx.arc(canvas.width / 2, canvas.height / 2, 40, 0, Math.PI * 2);
                ctx.stroke();
                
                // –¢–µ–∫—Å—Ç
                ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
                ctx.font = 'bold 24px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('AI Dream Weaver', canvas.width / 2, canvas.height / 2 + 60);
                
                // –°–æ–∑–¥–∞–µ–º —Ç–µ–∫—Å—Ç—É—Ä—É –∏–∑ canvas
                try {
                    if (!scene.textures.exists('placeholder')) {
                        scene.textures.addCanvas('placeholder', canvas);
                        console.log('–¢–µ–∫—Å—Ç—É—Ä–∞ placeholder —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ');
                        return 'placeholder';
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ–∫—Å—Ç—É—Ä—ã –∏–∑ canvas:', error);
                }
                
                return null;
            };
            
            // –°–æ–∑–¥–∞–µ–º placeholder —Ç–µ–∫—Å—Ç—É—Ä—É
            const textureKey = createPlaceholderImage();
            
            if (textureKey) {
                // –°–æ–∑–¥–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å placeholder
                sceneImage = scene.add.image(
                    scene.scale.width / 2,
                    scene.scale.height / 2,
                    textureKey
                ).setScale(0.7).setAlpha(0.3);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –ø—É–ª—å—Å–∞—Ü–∏–∏
                scene.tweens.add({
                    targets: sceneImage,
                    alpha: 0.5,
                    duration: 2000,
                    yoyo: true,
                    repeat: -1,
                    ease: 'Sine.easeInOut'
                });
            } else {
                // Fallback: –ø—Ä–æ—Å—Ç–æ —Å–æ–∑–¥–∞–µ–º —á–µ—Ä–Ω—ã–π –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫
                console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å placeholder, –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback');
                sceneImage = scene.add.rectangle(
                    scene.scale.width / 2,
                    scene.scale.height / 2,
                    512 * 0.7,
                    384 * 0.7,
                    0x0a0a1a
                ).setAlpha(0.3);
            }

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
            scene.scale.on('resize', (gameSize) => {
                if (sceneImage) {
                    sceneImage.setPosition(gameSize.width / 2, gameSize.height / 2);
                }
            });
        }

        function update() {
            // –ê–Ω–∏–º–∞—Ü–∏–∏ –∏–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
        }

        // ========== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô ==========
        function setupEventListeners() {
            // –ö–Ω–æ–ø–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è
            const actionBtn = document.getElementById('action-btn');
            const userInput = document.getElementById('user-input');
            
            if (actionBtn) {
                actionBtn.addEventListener('click', handleUserAction);
            }
            
            if (userInput) {
                userInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        handleUserAction();
                    }
                });
                
                userInput.addEventListener('input', () => {
                    if (userInput.value.length > 100) {
                        userInput.value = userInput.value.substring(0, 100);
                    }
                });
            }

            // –ö–Ω–æ–ø–∫–∏ –±–æ—è
            document.getElementById('btn-attack')?.addEventListener('click', () => handleBattle('attack'));
            document.getElementById('btn-item')?.addEventListener('click', () => handleBattle('item'));
            document.getElementById('btn-flee')?.addEventListener('click', () => handleBattle('flee'));
            document.getElementById('btn-special')?.addEventListener('click', () => handleBattle('special'));

            // –ö–Ω–æ–ø–∫–∏ –ø–∞–Ω–µ–ª–µ–π
            document.getElementById('toggle-inventory')?.addEventListener('click', () => togglePanel('inventory-panel'));
            document.getElementById('toggle-quests')?.addEventListener('click', () => togglePanel('quest-panel'));

            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∫—Ä—ã—Ç–∏–µ –ø–∞–Ω–µ–ª–µ–π –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ
            document.addEventListener('click', (e) => {
                const panels = ['inventory-panel', 'quest-panel'];
                const toggles = ['toggle-inventory', 'toggle-quests'];
                
                const clickedPanel = panels.some(id => 
                    document.getElementById(id)?.contains(e.target)
                );
                const clickedToggle = toggles.some(id => 
                    document.getElementById(id)?.contains(e.target)
                );
                
                if (!clickedPanel && !clickedToggle) {
                    panels.forEach(id => {
                        const panel = document.getElementById(id);
                        if (panel) panel.style.display = 'none';
                    });
                }
            });

            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
            window.addEventListener('beforeunload', saveGame);
            window.addEventListener('pagehide', saveGame);

            // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
            setInterval(saveGame, 30000);

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
            window.addEventListener('resize', () => {
                if (game && game.scale) {
                    game.scale.refresh();
                }
            });

            // Touch events –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
            document.addEventListener('touchstart', handleTouch, { passive: true });
        }

        // ========== –û–°–ù–û–í–ù–ê–Ø –õ–û–ì–ò–ö–ê –ò–ì–†–´ ==========
        async function handleUserAction() {
            if (isGenerating || battleAnimationActive) {
                showNotification('‚è≥ –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ...');
                return;
            }

            const input = document.getElementById('user-input');
            const btn = document.getElementById('action-btn');
            const userText = input?.value.trim();

            if (!userText) {
                showNotification('‚úèÔ∏è –í–≤–µ–¥–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ!');
                input?.focus();
                return;
            }

            // –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∫–Ω–æ–ø–æ–∫ –≤—ã–±–æ—Ä–∞
            clearChoiceButtons();

            // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
            if (btn) btn.disabled = true;
            isGenerating = true;

            // –î–æ–±–∞–≤–ª—è–µ–º –¥–µ–π—Å—Ç–≤–∏–µ –∏–≥—Ä–æ–∫–∞ –≤ –∏—Å—Ç–æ—Ä–∏—é
            addStoryText(`<i style="color:#88ff88">üë§ –í—ã: "${userText}"</i>`);

            try {
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ API
                if (!(await checkAPIConnection())) {
                    throw new Error('–ù–µ–π—Ä–æ—Å–µ—Ç–∏ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ª–æ–∫–∞–ª—å–Ω—É—é –ª–æ–≥–∏–∫—É.');
                }

                // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤ –±–æ—è
                if (await tryTriggerBattle(userText)) {
                    input.value = '';
                    return;
                }

                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∫–≤–µ—Å—Ç–æ–≤
                checkQuestProgress(userText);

                // –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç –Ω–µ–π—Ä–æ—Å–µ—Ç–∏
                const story = await askLLM(userText);
                gameState.history.push(story);
                addStoryText(story);

                // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ)
                generateImageForStory(story, userText).catch(error => {
                    console.warn('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ:', error);
                    showNotification('‚ö†Ô∏è –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º...');
                });

                // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞
                addChoiceButtons(story);

                // –°–ª—É—á–∞–π–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ
                if (Math.random() < 0.3) {
                    triggerRandomEvent(story);
                }

                // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –ª–æ–∫–∞—Ü–∏–π
                updateDiscoveredLocations(userText);

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–µ–π—Å—Ç–≤–∏—è:', error);
                
                // Fallback –ª–æ–≥–∏–∫–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ API
                const fallbackResponses = [
                    `–í—ã "${userText.toLowerCase()}" –≤ –º–∏—Ä–µ —Å–Ω–æ–≤. –ß—Ç–æ –±—É–¥–µ—Ç–µ –¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ?`,
                    `"${userText}" - –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π –≤—ã–±–æ—Ä. –ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –≤–∞—à–µ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ.`,
                    `–ú–∏—Ä —Å–Ω–æ–≤ –æ—Ç–∫–ª–∏–∫–∞–µ—Ç—Å—è –Ω–∞ –≤–∞—à–µ –¥–µ–π—Å—Ç–≤–∏–µ "${userText.substring(0, 30)}..."`
                ];
                
                const randomResponse = fallbackResponses[Math.floor(Math.random() * fallbackResponses.length)];
                addStoryText(randomResponse);
                
                // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞
                const standardChoices = [
                    '1. –ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç—å –¥–∞–ª—å—à–µ',
                    '2. –û—Å–º–æ—Ç—Ä–µ—Ç—å—Å—è –≤–æ–∫—Ä—É–≥',
                    '3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å',
                    '4. –ò—Å–∫–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫–∏'
                ];
                
                addChoiceButtons(standardChoices.join('\n'));
                
                showNotification('‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞');

            } finally {
                // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
                if (btn) {
                    btn.disabled = false;
                    setTimeout(() => {
                        btn.disabled = false;
                    }, 1000);
                }
                isGenerating = false;
                if (input) {
                    input.value = '';
                    input.focus();
                }
                
                saveGame();
                updateUI();
            }
        }

        // ========== API –§–£–ù–ö–¶–ò–ò ==========
        async function checkAPIConnection() {
  try {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º health endpoint
    const response = await fetch('/api/health', {
      method: 'GET',
      headers: { 
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      }
    });
    
    if (response.ok) {
      try {
        const data = await response.json();
        console.log('API —Å—Ç–∞—Ç—É—Å:', data);
        return true;
      } catch (jsonError) {
        console.warn('–û—Ç–≤–µ—Ç –Ω–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON, –Ω–æ endpoint –¥–æ—Å—Ç—É–ø–µ–Ω');
        return true;
      }
    }
    return false;
  } catch (error) {
    console.warn('–ü—Ä–æ–≤–µ—Ä–∫–∞ API –Ω–µ —É–¥–∞–ª–∞—Å—å:', error);
    return false;
  }
}

        async function askLLM(userAction) {
            try {
                const prompt = `
                    –ò–≥—Ä–æ–∫ –≤ —Ñ—ç–Ω—Ç–µ–∑–∏-–º–∏—Ä–µ —Å–Ω–æ–≤. –ú–∏—Ä –≤–æ–ª—à–µ–±–Ω—ã–π, –º–∞–≥–∏—á–µ—Å–∫–∏–π, –ø–æ–ª–Ω—ã–π —Ç–∞–π–Ω.
                    –î–µ–π—Å—Ç–≤–∏–µ –∏–≥—Ä–æ–∫–∞: "${userAction}".
                    
                    –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π –∫—Ä–∞—Ç–∫–æ–µ, –∞—Ç–º–æ—Å—Ñ–µ—Ä–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥—è—â–µ–≥–æ (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è).
                    –ó–∞—Ç–µ–º –ø—Ä–µ–¥–ª–æ–∂–∏ 3-4 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–∞ –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π, –ø—Ä–æ–Ω—É–º–µ—Ä–æ–≤–∞–≤ –∏—Ö (1. ... 2. ... 3. ... 4. ...).
                    
                    –ï—Å–ª–∏ –¥–µ–π—Å—Ç–≤–∏–µ —Å–≤—è–∑–∞–Ω–æ —Å –ø–æ–∏—Å–∫–æ–º –ø—Ä–µ–¥–º–µ—Ç–∞ –∏–ª–∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ–º —Å –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–º, –æ–ø–∏—à–∏ —ç—Ç–æ.
                    –°–æ—Ö—Ä–∞–Ω—è–π —Ç–æ–Ω —Ñ—ç–Ω—Ç–µ–∑–∏ –∏ –º–∞–≥–∏–∏. –ò–∑–±–µ–≥–∞–π —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤.
                    –û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.
                `;

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000);

                const response = await fetch(LLM_API, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'local-model',
                        messages: [
                            {
                                role: 'system',
                                content: '–¢—ã –º–∞—Å—Ç–µ—Ä –ø–æ–≤–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –≤ —Ñ—ç–Ω—Ç–µ–∑–∏-–º–∏—Ä–µ —Å–Ω–æ–≤. –û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ, –∞—Ç–º–æ—Å—Ñ–µ—Ä–Ω–æ –∏ –ø—Ä–µ–¥–ª–∞–≥–∞–π –≤–∞—Ä–∏–∞–Ω—Ç—ã –¥–µ–π—Å—Ç–≤–∏–π.'
                            },
                            {
                                role: 'user',
                                content: prompt
                            }
                        ],
                        temperature: 0.8,
                        max_tokens: 500,
                        stream: false
                    }),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`LLM API error: ${response.status} - ${errorText}`);
                }

                const data = await response.json();
                return data.choices?.[0]?.message?.content || '–ù–µ—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç –Ω–µ–π—Ä–æ—Å–µ—Ç–∏.';

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ LLM:', error);
                throw error;
            }
        }

        async function generateImageForStory(story, userAction) {
            if (isGenerating) return;
            
            isGenerating = true;
            showNotification('üé® –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...');

            try {
                // –°–æ–∑–¥–∞–µ–º –ø—Ä–æ–º–ø—Ç –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                const imagePrompt = `
                    fantasy art, digital painting, ${userAction}, 
                    dream world, magical, mystical, detailed, cinematic lighting, 
                    beautiful, atmospheric, epic, 4k, trending on artstation
                `.replace(/\n/g, ' ').trim();

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 60000);

                const response = await fetch(SD_API, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        prompt: imagePrompt,
                        negative_prompt: "blurry, ugly, text, watermark, signature, bad quality, deformed, distorted",
                        steps: 25,
                        width: 768,
                        height: 512,
                        cfg_scale: 7.5,
                        sampler_index: "Euler a",
                        enable_hr: false,
                        denoising_strength: 0.7,
                        seed: -1
                    }),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('SD API error:', errorText);
                    showNotification('‚ö†Ô∏è –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
                    return;
                }

                const data = await response.json();
                
                if (!data.images || !data.images[0]) {
                    throw new Error('–ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –æ—Ç–≤–µ—Ç–µ');
                }

                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ Phaser
                updatePhaserImage(data.images[0]);
                
                showNotification('‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ!');

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', error);
                showNotification('‚ö†Ô∏è –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ');
                
                // Fallback: —Å–æ–∑–¥–∞–µ–º –≥—Ä–∞–¥–∏–µ–Ω—Ç–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                createFallbackImage(userAction);
            } finally {
                isGenerating = false;
            }
        }

        // ========== PHASER –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø (–ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø) ==========
        function updatePhaserImage(base64Image) {
            if (!game || !game.scene || !game.scene.scenes[0]) {
                console.warn('Phaser —Å—Ü–µ–Ω–∞ –Ω–µ –≥–æ—Ç–æ–≤–∞');
                createFallbackImage('–°—Ü–µ–Ω–∞ –Ω–µ –≥–æ—Ç–æ–≤–∞');
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å base64 —Å—Ç—Ä–æ–∫–∏
            if (!base64Image || typeof base64Image !== 'string' || base64Image.length < 100) {
                console.warn('–ù–µ–≤–∞–ª–∏–¥–Ω–∞—è base64 —Å—Ç—Ä–æ–∫–∞');
                createFallbackImage('–ù–µ–≤–∞–ª–∏–¥–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
                return;
            }

            const scene = game.scene.scenes[0];
            
            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            const img = new Image();
            img.crossOrigin = 'anonymous';
            
            // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
            img.onerror = (error) => {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ Image –æ–±—ä–µ–∫—Ç:', error);
                
                // –°–æ–∑–¥–∞–µ–º fallback –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                createFallbackImage('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
                showNotification('‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ä–µ–∑–µ—Ä–≤–Ω–∞—è –≥—Ä–∞—Ñ–∏–∫–∞.');
            };
            
            img.onload = () => {
                console.log('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ –≤ Image –æ–±—ä–µ–∫—Ç');
                
                try {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ç–µ–∫—Å—Ç—É—Ä—É
                    if (scene.textures.exists(currentImageKey)) {
                        scene.textures.get(currentImageKey).setSource(img);
                    } else {
                        scene.textures.addImage(currentImageKey, img);
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                    if (sceneImage) {
                        sceneImage.setTexture(currentImageKey);
                        sceneImage.setAlpha(1);
                        
                        // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è
                        scene.tweens.add({
                            targets: sceneImage,
                            alpha: { from: 0, to: 1 },
                            scale: { from: 0.8, to: 0.7 },
                            duration: 1000,
                            ease: 'Back.easeOut'
                        });
                    } else {
                        sceneImage = scene.add.image(
                            scene.scale.width / 2,
                            scene.scale.height / 2,
                            currentImageKey
                        ).setScale(0.7);
                    }
                    
                    // –ú–µ–Ω—è–µ–º –∫–ª—é—á –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                    currentImageKey = 'generated_' + Date.now();
                    
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–µ–∫—Å—Ç—É—Ä—ã –≤ Phaser:', error);
                    createFallbackImage('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–µ–∫—Å—Ç—É—Ä—ã');
                }
            };
            
            // –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            try {
                img.src = `data:image/png;base64,${base64Image}`;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ src –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', error);
                createFallbackImage('–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ src');
            }
        }

        function createFallbackImage(action) {
            if (!game || !game.scene || !game.scene.scenes[0]) {
                console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å fallback –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: —Å—Ü–µ–Ω–∞ –Ω–µ –≥–æ—Ç–æ–≤–∞');
                return;
            }
            
            const scene = game.scene.scenes[0];
            const canvas = document.createElement('canvas');
            canvas.width = 768;
            canvas.height = 512;
            const ctx = canvas.getContext('2d');
            
            if (!ctx) {
                console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç canvas');
                return;
            }
            
            // –°–æ–∑–¥–∞–µ–º –≥—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–π —Ñ–æ–Ω
            const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
            gradient.addColorStop(0, '#0a0a1a');
            gradient.addColorStop(0.5, '#1a1a2e');
            gradient.addColorStop(1, '#16213e');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç
            ctx.fillStyle = 'rgba(255, 255, 255, 0.1)';
            ctx.font = 'bold 40px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('AI Dream Weaver', canvas.width / 2, canvas.height / 2 - 40);
            
            ctx.fillStyle = 'rgba(138, 47, 255, 0.3)';
            ctx.font = '20px Arial';
            ctx.fillText((action || '–ú–∏—Ä —Å–Ω–æ–≤').substring(0, 50) + '...', canvas.width / 2, canvas.height / 2 + 20);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –º–∞–≥–∏—á–µ—Å–∫–∏–µ —á–∞—Å—Ç–∏—Ü—ã
            for (let i = 0; i < 100; i++) {
                const x = Math.random() * canvas.width;
                const y = Math.random() * canvas.height;
                const radius = Math.random() * 3;
                const alpha = Math.random() * 0.5;
                
                ctx.beginPath();
                ctx.arc(x, y, radius, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(74, 111, 255, ${alpha})`;
                ctx.fill();
            }
            
            // –°–æ–∑–¥–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–∑ canvas
            const img = new Image();
            img.onload = () => {
                try {
                    if (scene.textures.exists('fallback')) {
                        scene.textures.get('fallback').setSource(img);
                    } else {
                        scene.textures.addImage('fallback', img);
                    }
                    
                    if (sceneImage) {
                        sceneImage.setTexture('fallback');
                        sceneImage.setAlpha(0.7);
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è fallback —Ç–µ–∫—Å—Ç—É—Ä—ã:', error);
                }
            };
            img.onerror = (error) => {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ fallback –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', error);
            };
            
            try {
                img.src = canvas.toDataURL();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è Data URL –¥–ª—è fallback –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', error);
            }
        }

        // ========== –°–ò–°–¢–ï–ú–ê –ë–û–Ø ==========
        async function tryTriggerBattle(userInput) {
            // –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ –≤ –±–æ—é
            if (gameState.currentBattle) return false;
            
            const dangerWords = ['–ø–µ—â–µ—Ä–∞', '—Ö—Ä–∞–º', '–ª–µ—Å', '–ª–∞–±–∏—Ä–∏–Ω—Ç', '—Ç–µ–º–Ω—ã–π', '—á—É–¥–æ–≤–∏—â–µ', '–≤—Ä–∞–≥', '—Å—Ä–∞–∑–∏—Ç—å—Å—è', '–±–∏—Ç–≤–∞', '–º–æ–Ω—Å—Ç—Ä', '–¥—Ä–∞–∫–æ–Ω', '—Ç—Ä–æ–ª–ª—å'];
            const lowerInput = userInput.toLowerCase();
            
            // 25% —à–∞–Ω—Å –±–æ—è –ø—Ä–∏ –æ–ø–∞—Å–Ω—ã—Ö —Å–ª–æ–≤–∞—Ö
            if (dangerWords.some(word => lowerInput.includes(word)) && Math.random() < 0.25) {
                const enemy = await generateEnemy();
                gameState.currentBattle = {
                    enemy: enemy,
                    turn: 'player',
                    log: []
                };
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º UI –±–æ—è
                document.getElementById('battle-ui').style.display = 'block';
                updateBattleUI();
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å –≤ –∏—Å—Ç–æ—Ä–∏—é
                addStoryText(`<span style="color:#ff5555;font-weight:bold;">‚ö†Ô∏è –ò–∑ —Ç–µ–º–Ω–æ—Ç—ã –ø–æ—è–≤–ª—è–µ—Ç—Å—è ${enemy.name}!</span>`);
                
                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—Ä–∞–≥–∞
                generateImageForStory(`fantasy enemy ${enemy.name}, dark, menacing, detailed, digital art`, userInput)
                    .catch(() => console.log('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—Ä–∞–≥–∞ –Ω–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ'));
                
                return true;
            }
            
            return false;
        }

        async function generateEnemy() {
            const enemies = [
                { name: '–ì–æ–±–ª–∏–Ω-–≤–æ–∏–Ω', hp: 40, attack: 8, defense: 3, exp: 30 },
                { name: '–û—Ä–∫-–±–µ—Ä—Å–µ—Ä–∫', hp: 60, attack: 12, defense: 5, exp: 50 },
                { name: '–¢—ë–º–Ω—ã–π –ø—Ä–∏–∑—Ä–∞–∫', hp: 35, attack: 10, defense: 2, exp: 40 },
                { name: '–ö–∞–º–µ–Ω–Ω—ã–π –≥–æ–ª–µ–º', hp: 80, attack: 15, defense: 8, exp: 70 },
                { name: '–ú–∞–≥–∏—á–µ—Å–∫–∏–π —ç–ª–µ–º–µ–Ω—Ç–∞–ª—å', hp: 50, attack: 14, defense: 4, exp: 60 }
            ];
            
            const enemy = enemies[Math.floor(Math.random() * enemies.length)];
            return {
                ...enemy,
                maxHp: enemy.hp,
                currentHp: enemy.hp
            };
        }

        async function handleBattle(action) {
            if (!gameState.currentBattle || battleAnimationActive) return;
            
            battleAnimationActive = true;
            const battle = gameState.currentBattle;
            let message = '';
            
            switch (action) {
                case 'attack':
                    const playerDamage = Math.max(1, gameState.player.attack + Math.floor(Math.random() * 6) - battle.enemy.defense);
                    battle.enemy.currentHp -= playerDamage;
                    message += `‚öîÔ∏è –í—ã –Ω–∞–Ω–æ—Å–∏—Ç–µ ${playerDamage} —É—Ä–æ–Ω–∞! `;
                    
                    if (battle.enemy.currentHp <= 0) {
                        await endBattle(true);
                        battleAnimationActive = false;
                        return;
                    }
                    
                    const enemyDamage = Math.max(1, battle.enemy.attack + Math.floor(Math.random() * 6) - gameState.player.defense);
                    gameState.player.hp -= enemyDamage;
                    message += `üòà ${battle.enemy.name} –∫–æ–Ω—Ç—Ä–∞—Ç–∞–∫—É–µ—Ç (${enemyDamage} —É—Ä–æ–Ω–∞). `;
                    
                    if (gameState.player.hp <= 0) {
                        await endBattle(false);
                        battleAnimationActive = false;
                        return;
                    }
                    break;
                    
                case 'item':
                    const potionIndex = gameState.inventory.findIndex(i => i.includes('–ó–µ–ª—å–µ'));
                    if (potionIndex > -1) {
                        gameState.player.hp = Math.min(gameState.player.maxHp, gameState.player.hp + 30);
                        gameState.inventory.splice(potionIndex, 1);
                        message += "üß™ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ –∑–µ–ª—å–µ –∑–¥–æ—Ä–æ–≤—å—è (+30 HP). ";
                    } else {
                        message += "‚ùå –í –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ –Ω–µ—Ç –∑–µ–ª–∏–π! ";
                    }
                    break;
                    
                case 'flee':
                    if (Math.random() > 0.5) {
                        message = "üèÉ –í–∞–º —É–¥–∞–ª–æ—Å—å —Å–±–µ–∂–∞—Ç—å!";
                        endBattle(null);
                        battleAnimationActive = false;
                        return;
                    } else {
                        message = "‚ùå –ü–æ–±–µ–≥ –Ω–µ —É–¥–∞–ª—Å—è! ";
                        const enemyDamage = Math.max(1, battle.enemy.attack - gameState.player.defense);
                        gameState.player.hp -= enemyDamage;
                        message += `${battle.enemy.name} –∞—Ç–∞–∫—É–µ—Ç (${enemyDamage} —É—Ä–æ–Ω–∞).`;
                    }
                    break;
                    
                case 'special':
                    if (gameState.player.mana >= 20) {
                        gameState.player.mana -= 20;
                        const specialDamage = gameState.player.attack * 2;
                        battle.enemy.currentHp -= specialDamage;
                        message += `‚ú® –ú–∞–≥–∏—á–µ—Å–∫–∞—è –∞—Ç–∞–∫–∞ –Ω–∞–Ω–æ—Å–∏—Ç ${specialDamage} —É—Ä–æ–Ω–∞! `;
                        
                        if (battle.enemy.currentHp <= 0) {
                            await endBattle(true);
                            battleAnimationActive = false;
                            return;
                        }
                    } else {
                        message += "‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–∞–Ω—ã! ";
                    }
                    break;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–≥ –±–æ—è
            battle.log.push(message);
            updateBattleLog();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º UI
            updateBattleUI();
            updateUI();
            
            battleAnimationActive = false;
        }

        async function endBattle(victory) {
            const enemyName = gameState.currentBattle?.enemy?.name || '–≤—Ä–∞–≥';
            const battle = gameState.currentBattle;
            
            // –°–∫—Ä—ã–≤–∞–µ–º UI –±–æ—è
            document.getElementById('battle-ui').style.display = 'none';
            gameState.currentBattle = null;
            
            if (victory === true) {
                // –ù–∞–≥—Ä–∞–¥–∞ –∑–∞ –ø–æ–±–µ–¥—É
                const expReward = battle.enemy.exp || 30;
                const goldReward = Math.floor(Math.random() * 20) + 10;
                
                gameState.player.exp += expReward;
                gameState.player.gold += goldReward;
                gameState.inventory.push(`–¢—Ä–æ—Ñ–µ–π –æ—Ç ${enemyName}`);
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Ä–æ–≤–Ω—è
                if (gameState.player.exp >= 100) {
                    gameState.player.level++;
                    gameState.player.attack += 3;
                    gameState.player.defense += 2;
                    gameState.player.maxHp += 20;
                    gameState.player.hp = gameState.player.maxHp;
                    gameState.player.maxMana += 10;
                    gameState.player.mana = gameState.player.maxMana;
                    gameState.player.exp = 0;
                    
                    showNotification(`üéâ –ù–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å: ${gameState.player.level}!`);
                    addStoryText(`<span style="color:#FFD700">üåü –í—ã –¥–æ—Å—Ç–∏–≥–ª–∏ —É—Ä–æ–≤–Ω—è ${gameState.player.level}! –°–∏–ª—ã —Ä–∞—Å—Ç—É—Ç...</span>`);
                }
                
                addStoryText(`<span style="color:#88ff88">‚úÖ –ü–æ–±–µ–¥–∞ –Ω–∞–¥ ${enemyName}! –ü–æ–ª—É—á–µ–Ω–æ: ${expReward} –æ–ø—ã—Ç–∞, ${goldReward} –∑–æ–ª–æ—Ç–∞.</span>`);
                
            } else if (victory === false) {
                // –ü–æ—Ä–∞–∂–µ–Ω–∏–µ
                gameState.player.hp = Math.max(1, gameState.player.hp);
                addStoryText("<span style='color:#ff8888'>üíÄ –í—ã –ø–æ–≤–µ—Ä–∂–µ–Ω—ã... –ß—É–¥–æ–º –≤—ã–∂–∏–ª–∏ —Å 1 HP.</span>");
                
            } else {
                // –ü–æ–±–µ–≥
                addStoryText("<span style='color:#ffaa00'>üèÉ –í—ã —É—Å–ø–µ—à–Ω–æ –æ—Ç—Å—Ç—É–ø–∏–ª–∏.</span>");
            }
            
            saveGame();
            updateUI();
        }

        // ========== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========
        function togglePanel(panelId) {
            const panel = document.getElementById(panelId);
            if (!panel) return;
            
            const isVisible = panel.style.display === 'block';
            panel.style.display = isVisible ? 'none' : 'block';
            
            // –°–∫—Ä—ã–≤–∞–µ–º –¥—Ä—É–≥–∏–µ –ø–∞–Ω–µ–ª–∏
            if (panelId === 'inventory-panel') {
                document.getElementById('quest-panel').style.display = 'none';
            } else {
                document.getElementById('inventory-panel').style.display = 'none';
            }
        }

        function addStoryText(text) {
            const panel = document.getElementById('story-text');
            if (panel) {
                panel.innerHTML += '<br><br>' + text;
                panel.scrollTop = panel.scrollHeight;
            }
        }

        function clearChoiceButtons() {
            document.querySelectorAll('.choice-btn').forEach(btn => btn.remove());
        }

        function addChoiceButtons(storyText) {
            clearChoiceButtons();
            
            // –ò—â–µ–º –ø—Ä–æ–Ω—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –≤ —Ç–µ–∫—Å—Ç–µ
            const choiceRegex = /\d\.\s+([^\n]+)/g;
            const choices = storyText.match(choiceRegex);
            
            if (choices && choices.length > 0) {
                // –ó–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
                choices.forEach((choice, idx) => {
                    setTimeout(() => {
                        const btn = document.createElement('button');
                        btn.className = 'choice-btn';
                        btn.textContent = choice.replace(/^\d\.\s+/, '').trim();
                        btn.style.opacity = '0';
                        btn.style.transform = 'translateY(10px)';
                        
                        btn.onclick = () => {
                            const input = document.getElementById('user-input');
                            if (input) {
                                input.value = btn.textContent;
                                handleUserAction();
                            }
                        };
                        
                        document.body.appendChild(btn);
                        
                        // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è
                        setTimeout(() => {
                            btn.style.transition = 'all 0.3s ease';
                            btn.style.opacity = '1';
                            btn.style.transform = 'translateY(0)';
                        }, 50);
                    }, idx * 100);
                });
            }
        }

        function showNotification(text, duration = 3000) {
            const notification = document.getElementById('notification');
            if (!notification) return;
            
            notification.textContent = text;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, duration);
        }

        function updateUI() {
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ HP
            const hpPercent = (gameState.player.hp / gameState.player.maxHp) * 100;
            const hpFill = document.getElementById('player-hp-fill');
            if (hpFill) {
                hpFill.style.width = hpPercent + '%';
                hpFill.className = hpPercent < 30 ? 'hp-fill danger' : 'hp-fill';
                hpFill.querySelector('.hp-text').textContent = `${Math.round(hpPercent)}%`;
            }
            
            document.getElementById('hp-value').textContent = `${gameState.player.hp}/${gameState.player.maxHp}`;
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–æ–≤
            document.getElementById('player-level').textContent = gameState.player.level;
            document.getElementById('player-attack').textContent = gameState.player.attack;
            document.getElementById('player-defense').textContent = gameState.player.defense;
            document.getElementById('player-exp').textContent = gameState.player.exp;
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è
            const invList = document.getElementById('inventory-list');
            if (invList) {
                invList.innerHTML = gameState.inventory.map(item => 
                    `<li>${item}</li>`
                ).join('');
            }
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–≤–µ—Å—Ç–æ–≤
            updateQuestsUI();
        }

        function updateBattleUI() {
            if (!gameState.currentBattle) return;
            
            const battle = gameState.currentBattle;
            const enemyHpPercent = (battle.enemy.currentHp / battle.enemy.maxHp) * 100;
            const enemyHpFill = document.getElementById('enemy-hp-fill');
            
            if (enemyHpFill) {
                enemyHpFill.style.width = enemyHpPercent + '%';
                enemyHpFill.className = enemyHpPercent < 30 ? 'hp-fill danger' : 'hp-fill';
                enemyHpFill.querySelector('.hp-text').textContent = `${Math.round(enemyHpPercent)}%`;
            }
            
            document.getElementById('enemy-name').textContent = battle.enemy.name;
            document.getElementById('enemy-hp-value').textContent = `${battle.enemy.currentHp}/${battle.enemy.maxHp}`;
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ HP –∏–≥—Ä–æ–∫–∞ –≤ –±–æ—é
            const playerHpPercent = (gameState.player.hp / gameState.player.maxHp) * 100;
            const playerHpFill = document.getElementById('player-battle-hp-fill');
            
            if (playerHpFill) {
                playerHpFill.style.width = playerHpPercent + '%';
                playerHpFill.className = playerHpPercent < 30 ? 'hp-fill danger' : 'hp-fill';
                playerHpFill.querySelector('.hp-text').textContent = `${Math.round(playerHpPercent)}%`;
            }
            
            document.getElementById('player-battle-hp').textContent = `${gameState.player.hp}/${gameState.player.maxHp}`;
        }

        function updateBattleLog() {
            if (!gameState.currentBattle) return;
            
            const logElement = document.getElementById('battle-log');
            if (logElement && gameState.currentBattle.log) {
                const lastMessages = gameState.currentBattle.log.slice(-3);
                logElement.innerHTML = lastMessages.map(msg => 
                    `<div style="margin-bottom: 5px;">${msg}</div>`
                ).join('');
                logElement.scrollTop = logElement.scrollHeight;
            }
        }

        function updateQuestsUI() {
            const quests = gameState.quests.main.objectives;
            let completedCount = 0;
            
            quests.forEach((quest, index) => {
                const statusElement = document.getElementById(`quest-${index + 1}-status`);
                const textElement = document.getElementById(`quest-${index + 1}-text`);
                
                if (statusElement && textElement) {
                    statusElement.textContent = quest.done ? '‚úÖ' : '‚è≥';
                    textElement.textContent = quest.text;
                    textElement.style.color = quest.done ? '#88ff88' : '#ffffff';
                    
                    if (quest.done) completedCount++;
                }
            });
            
            // –ü—Ä–æ–≥—Ä–µ—Å—Å
            const progress = Math.round((completedCount / quests.length) * 100);
            document.getElementById('quest-progress').textContent = `${progress}%`;
            
            // –ü–æ–±–æ—á–Ω—ã–µ –∫–≤–µ—Å—Ç—ã
            const sideQuestsContainer = document.getElementById('side-quests-container');
            const sideQuestsList = document.getElementById('side-quests-list');
            
            if (gameState.quests.side.length > 0) {
                sideQuestsContainer.style.display = 'block';
                sideQuestsList.innerHTML = gameState.quests.side.map(quest => 
                    `<div style="margin: 8px 0; padding: 10px; background: rgba(138, 47, 255, 0.1); border-radius: 8px;">
                        ${quest.completed ? '‚úÖ' : '‚è≥'} ${quest.title}
                    </div>`
                ).join('');
            }
        }

        function checkQuestProgress(input) {
            const lowerInput = input.toLowerCase();
            let updated = false;
            
            gameState.quests.main.objectives.forEach(obj => {
                if (!obj.done && lowerInput.includes(obj.keyword)) {
                    obj.done = true;
                    updated = true;
                    
                    showNotification(`‚úÖ –¶–µ–ª—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∞: ${obj.text}`);
                    addStoryText(`<span style="color:#FFD700">üåü –í—ã –≤—ã–ø–æ–ª–Ω–∏–ª–∏ —Ü–µ–ª—å: ${obj.text}</span>`);
                    
                    // –ù–∞–≥—Ä–∞–¥–∞ –∑–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ü–µ–ª–∏
                    gameState.player.exp += 25;
                    gameState.player.gold += 50;
                    gameState.inventory.push(`–ù–∞–≥—Ä–∞–¥–∞ –∑–∞ "${obj.text}"`);
                }
            });
            
            if (updated) {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –≤—Å–µ–≥–æ –∫–≤–µ—Å—Ç–∞
                const allDone = gameState.quests.main.objectives.every(o => o.done);
                if (allDone && !gameState.quests.main.completed) {
                    gameState.quests.main.completed = true;
                    showNotification('üéâ –ü–û–ë–ï–î–ê! –ì–ª–∞–≤–Ω—ã–π –∫–≤–µ—Å—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω!');
                    addStoryText(`<span style="color:#FFD700;font-size:18px;">
                        üåüüåü –í–´ –ü–û–ë–ï–î–ò–õ–ò! üåüüåü<br>
                        –•—Ä–∞–Ω–∏—Ç–µ–ª—å –°–Ω–æ–≤ –ø—Ä–æ–±—É–∂–¥–µ–Ω! –ú–∏—Ä —Å–Ω–æ–≤ —Å–ø–∞—Å–µ–Ω –±–ª–∞–≥–æ–¥–∞—Ä—è –≤–∞–º!
                    </span>`);
                }
                
                updateUI();
            }
        }

        function triggerRandomEvent(story) {
            const events = [
                {
                    trigger: () => Math.random() < 0.2,
                    action: () => {
                        const gold = Math.floor(Math.random() * 30) + 10;
                        gameState.player.gold += gold;
                        addStoryText(`<span style="color:#FFD700">üí∞ –í—ã –Ω–∞—à–ª–∏ ${gold} –∑–æ–ª–æ—Ç—ã—Ö –º–æ–Ω–µ—Ç!</span>`);
                    }
                },
                {
                    trigger: () => Math.random() < 0.15 && gameState.player.hp < gameState.player.maxHp * 0.8,
                    action: () => {
                        gameState.player.hp = Math.min(gameState.player.maxHp, gameState.player.hp + 20);
                        addStoryText(`<span style="color:#88ff88">‚ù§Ô∏è –í—ã —á—É–≤—Å—Ç–≤—É–µ—Ç–µ –ø—Ä–∏–ª–∏–≤ —Å–∏–ª (+20 HP)!</span>`);
                    }
                },
                {
                    trigger: () => Math.random() < 0.1,
                    action: () => {
                        const items = ['–ú–∞–≥–∏—á–µ—Å–∫–∏–π –∞–º—É–ª–µ—Ç', '–°–≤–∏—Ç–æ–∫ —Ç–µ–ª–µ–ø–æ—Ä—Ç–∞—Ü–∏–∏', '–≠–ª–∏–∫—Å–∏—Ä –º—É–¥—Ä–æ—Å—Ç–∏', '–ö–∞—Ä—Ç–∞ —Å–æ–∫—Ä–æ–≤–∏—â'];
                        const item = items[Math.floor(Math.random() * items.length)];
                        gameState.inventory.push(item);
                        addStoryText(`<span style="color:#8a2fff">üéÅ –í—ã –Ω–∞—à–ª–∏: ${item}!</span>`);
                    }
                }
            ];
            
            events.forEach(event => {
                if (event.trigger()) {
                    event.action();
                }
            });
        }

        function updateDiscoveredLocations(userInput) {
            const locations = {
                '–ª–µ—Å': '–¢–∞–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –õ–µ—Å',
                '–ø–µ—â–µ—Ä–∞': '–¢–µ–º–Ω—ã–µ –ü–µ—â–µ—Ä—ã',
                '—Ö—Ä–∞–º': '–î—Ä–µ–≤–Ω–∏–π –•—Ä–∞–º',
                '–≥–æ—Ä–æ–¥': '–ó–∞–±—Ä–æ—à–µ–Ω–Ω—ã–π –ì–æ—Ä–æ–¥',
                '–æ–∑–µ—Ä–æ': '–û–∑–µ—Ä–æ –û—Ç—Ä–∞–∂–µ–Ω–∏–π',
                '–≥–æ—Ä–∞': '–ì–æ—Ä–∞ –í–µ—á–Ω–æ—Å—Ç–∏',
                '–±–∞—à–Ω—è': '–ó–∞–ø—Ä–µ—Ç–Ω–∞—è –ë–∞—à–Ω—è',
                '—Å–∞–¥': '–ú–∞–≥–∏—á–µ—Å–∫–∏–π –°–∞–¥'
            };
            
            const lowerInput = userInput.toLowerCase();
            Object.entries(locations).forEach(([keyword, location]) => {
                if (lowerInput.includes(keyword) && !gameState.discoveredLocations.includes(location)) {
                    gameState.discoveredLocations.push(location);
                    addStoryText(`<span style="color:#4a6fff">üó∫Ô∏è –ù–æ–≤–æ–µ –º–µ—Å—Ç–æ –æ—Ç–∫—Ä—ã—Ç–æ: ${location}!</span>`);
                }
            });
        }

        // ========== –°–û–•–†–ê–ù–ï–ù–ò–ï –ò–ì–†–´ ==========
        function saveGame() {
            try {
                localStorage.setItem('dreamWeaverSave', JSON.stringify(gameState));
                console.log('–ò–≥—Ä–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞');
            } catch (error) {
                console.warn('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
            }
        }

        function loadGame() {
            try {
                const saved = localStorage.getItem('dreamWeaverSave');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    
                    // –ê–∫–∫—É—Ä–∞—Ç–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
                    Object.keys(parsed).forEach(key => {
                        if (gameState[key] && typeof gameState[key] === 'object' && !Array.isArray(gameState[key])) {
                            Object.assign(gameState[key], parsed[key]);
                        } else {
                            gameState[key] = parsed[key];
                        }
                    });
                    
                    console.log('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ');
                    showNotification('üíæ –ü—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–≥—Ä—É–∂–µ–Ω!');
                }
            } catch (error) {
                console.warn('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
                localStorage.removeItem('dreamWeaverSave');
            }
        }

        // ========== TOUCH HANDLING ==========
        function handleTouch(e) {
            // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –¥–ª—è –ª—É—á—à–µ–≥–æ UX
            if (e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT') {
                return;
            }
            
            // –°–∫—Ä—ã–≤–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ input
            if (document.activeElement && document.activeElement.id === 'user-input') {
                document.activeElement.blur();
            }
        }

        // ========== –ì–õ–û–ë–ê–õ–¨–ù–´–ô –î–û–°–¢–£–ü ==========
        window.AIDreamWeaver = {
            gameState,
            saveGame,
            loadGame,
            showNotification,
            togglePanel
        };

        // ========== –ö–û–ù–ï–¶ –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–ò ==========
        console.log('AI Dream Weaver –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!');
        console.log('–ò–≥—Ä–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:', gameState);
    </script>
</body>

</html>

